"use strict";var Util={};Util.GROUP_NOMECLATURE={year:"YYYY-MM-DD",month:"YYYY-MM-DD",week:"YYYY-MM-DD",day:"YYYY-MM-DD HH:00:00",ytd:"YYYY-MM-01"},Util.formatDemoData=function(t){return t.map(function(t){return{datetime:1e3*+t.datetime,sale:+t.sale.replace(",",""),user:t.user,creditcard:t.creditcard}})},Util.percentage=function(t){return parseFloat(t).toFixed(1)+"%"},Util.currency=function(t){return(Util.currencySymbol()||"")+(t||0).toFixed(2).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")},Util.currencySymbol=function(){var t=$('meta[name="app_currency"]').attr("content"),e=$('meta[name="app_local_currency"]').attr("content"),a=$('meta[name="app_local_currency_symbol"]').attr("content");return t==e?a:"USD"==t?"$":void 0},Util.unique=function(t,e){return _(t).map(function(t){return t[e]}).sort().uniq().value()},Util.clone=function(t){var e=JSON.stringify(t);return JSON.parse(e)},Util.options=function(t){return'<option value="">Todos</option>\n'+t.map(function(t){return'<option value="'+t+'">'+t+"</option>\n"}).join("")},Util.groupingByDate=function(t,e,a){var r={},n=Util.GROUP_NOMECLATURE[e];return t.forEach(function(t){var e=moment(t.datetime).format(n),a=r[e]||0;a+=t.sale,r[e]=a}),t=_.toPairs(r).map(function(t){return{datetime:moment(t[0]).valueOf(),sale:t[1]}}),t=_.sortBy(t,"datetime")},Util.groupingBy=function(t,e){var a=[],r=_.groupBy(t,e);return _.forEach(r,function(t,e){a.push({name:e,y:_.sumBy(t,"sale")})}),a=_.sortBy(a,e)},Util.calculateSeries=function(t,e,a){var r=t[t.length-2].datetime,n=_.last(t).sale,i=Util.currency(n),o=_.meanBy(t,"sale");$("#current-sale").val(i);var l=Util.enoughDataForUpright(t)&&!a;l&&(t.pop(),Util.addUpright(t,e)),t=Util.plotBySales(t);var s=[{type:"areaspline",name:"Ventas",data:t,zoneAxis:"x",marker:{symbol:"circle"}}];if(l){var d=s[0],c=_.last(d.data)[1],u=d.data.length-1;s.push(Util.clone(d)),s.push(Util.clone(d));var h=s[1],m=s[2];h.data[u][1]=n,d.data[u]={x:h.data[u][0],y:c,marker:{symbol:"circle",fillColor:"#4785B9",lineColor:"#fff",lineWidth:2,width:6,height:6}},d.zones=[{value:r,dashStyle:"solid",color:"transparent"},{dashStyle:"ShortDot",color:"rgba(255,255,255,0.7)"}],h.id="main",m.name="Promedio",m.dashStyle="Dash",m.color="rgba(255,255,255,0.4)",m.enableMouseTracking=!1,m.data=m.data.map(function(t){return t[1]=o,t}),m.lineWidth=1,m.states={hover:{lineWidth:1}},m.showInLegend=!1,m.line={tooltip:{followPointer:!1}},m.tooltip={enabled:!1},m.marker={enabled:!1},s=[m,d,h]}return s},Util.addMissingIntervals=function(t,e){if(0==t.length)return[];for(var a=e.interval.lesser,r=moment(e.start).valueOf(),n=moment(e.end).valueOf(),i=_.first(t).datetime,o=_.last(t).datetime,l=[i];r<o;)o=moment(o).subtract(1,a).valueOf(),l.push(o);for(;n>i;)i=moment(i).add(1,a).valueOf(),l.push(i);return l=_.sortBy(l),l=_.uniq(l),l.length!=t.length&&(_.last(l)>_.last(t).datetime&&l.pop(),_.first(l)<_.first(t).datetime&&l.shift()),l.map(function(e){var a=t.find(function(t){return t.datetime==e});return a||(a={datetime:e,sale:0}),a})},Util.addUpright=function(t,e){if(!Util.enoughDataForUpright(t))return!1;var a=Util.calculateNextDate(t,e),r=(Util.calculateAvgUpright(t),Util.calculateDiffUpright(t),Util.calculateDiffUpright(t,4,!0));return t.push({datetime:a,sale:r}),!0},Util.enoughDataForUpright=function(t){return t.length>2},Util.calculateNextDate=function(t,e){var a=_.last(t).datetime;return moment(a).add(1,e.lesser).valueOf()},Util.calculateAvgUpright=function(t){var e=_.takeRight(t,3);return _.meanBy(e,"sale")},Util.calculateDiffUpright=function(t,e,a){if(t.length<2)return 0;e&&(t=_.takeRight(t,e));var r=_.times(t.length-1);r=r.map(function(e,a){return t[a+1].sale-t[a].sale}),a&&(r=r.filter(function(t){return t>0}));var n=_.mean(r)||0;return _.last(t).sale+n},Util.plotBySales=function(t){return t=_.sortBy(t,["datetime"]),t.map(function(t){return[t.datetime,t.sale]})},Util.plotByUser=function(t){return t=_.sortBy(t,"name"),t=t.map(function(t,e){return{name:t.name,key:t.name,data:[t.y],legendIndex:e}})},Util.reduceTicksCount=function(t){var e=t.ticks,a=t.conditionLimit,r=t.ticksPerAxis,n=t.min,i=t.max;if(e.length>a){var o=i-n,l=o/r>>0,s=n;e=_.times(r,"").map(function(){return s+=l})}return e},Util.animateNumber=function(t){var e=t.attr("decimal")||0,a=0===e?1:Math.pow(10,e);t.animateNumber({number:t.attr("value")*a,numberStep:function(t,r){var n=Math.floor(t)/a,i=$(r.elem);e>0&&(n=n.toFixed(e)),n=n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),i.text(n)}},750)},Util.percentageFrom=function(t,e){return(e/t*100).toFixed(2)};var Charts={};Charts._pieCharts={},Charts.PIE_CHART_TYPES={creditcard:{title:" <br><b>Según Tarjeta de Crédito</b>",container:"pie-chart-cc"},category:{title:" <br><b>Según Tipo de Pago</b>",container:"pie-chart-cat"},device:{title:" <br><b>Por Dispositivo</b>",container:"pie-chart-device"}},Charts.LINE_CHART_NOMECLATURES={day:"D MMMM",days:"D MMMM YYYY",hour:"hh A",month:"MMMM"},Charts.buildLineChart=function(t,e,a){if(Charts._lineChart&&Charts._lineChart.destroy(),!t.length)return $("#current-sale").attr("value",0),Util.animateNumber($("#current-sale")),Dashboard.nodata("line-chart");var r=Charts.LINE_CHART_NOMECLATURES[e.lesser],n=_.sumBy(t,"sale")||0;$("#current-sale").attr("value",n),Util.animateNumber($("#current-sale"));var i=Util.calculateSeries(t,e,a);Dashboard.chartReady("line-chart"),Charts._lineChart=Highcharts.chart("line-chart",{credits:{enabled:!1},legend:{enabled:!1},chart:{style:{fontFamily:"'Gotham Rounded', sans-serif"},backgroundColor:"transparent",color:"#fff",height:280,type:"area"},title:{align:"left",style:{color:"#FFF",textTransform:"uppercase",fontSize:12},margin:40,text:e.title},yAxis:{gridLineColor:"transparent",title:{style:{color:"#fff"},text:"Ventas en Lempiras"},labels:{style:{color:"#fff"}},min:0},xAxis:{gridLineColor:"#ffffff",type:"datetime",minTickInterval:2e4,tickPositioner:function(t,a){var r=this.series[0].processedXData.slice(),n=_.first(r),i=_.last(r);n=moment(n),i=moment(i);var o=i.diff(n,e.lesser,!0);if(o>=40)r=Util.reduceTicksCount({ticks:r,conditionLimit:40,ticksPerAxis:20,min:t,max:a});else{var l=n;r=[n.valueOf()],_.times(o,function(){l.add(1,e.lesser);var t=l.valueOf();r.push(t)})}return r.info=this.tickPositions.info,r},labels:{rotation:-45,formatter:function(){var t=this.value,a=Charts.LINE_CHART_NOMECLATURES[e.lesser];return moment(t).locale("es").format(a.replace("MMMM","MMM")).valueOf()},style:{color:"#fff"}}},tooltip:{formatter:function(t){return"Promedio"!=this.series.name&&moment(this.key).locale("es").format(r)+"<br>Venta: <b>"+Util.currency(this.y)+"</b>"},backgroundColor:"#fff",borderRadius:4},plotOptions:{bar:{pointPadding:0,borderWidth:0},series:{events:{legendItemClick:function(t){t.preventDefault()}},dataLabels:{enabled:!0,crop:!1,overflow:"none",align:"left",verticalAlign:"middle",style:{textOutline:"2px #6F79CF"},formatter:function(){if("Promedio"!=this.series.name)return"";if(this.point.index>0)return"";var t=Util.currency(this.y);return'<span class="average-marker" style="baseline-shift:10px; opacity: 0.8; font-weight: normal;">'+this.series.name+": "+t+"</span>"}}},areaspline:{fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[]},marker:{radius:3},color:"#fff",lineWidth:2,states:{hover:{lineWidth:3}},threshold:null}},series:i})},Charts.buildPieChart=function(t,e,a){Charts._pieCharts[a]&&Charts._pieCharts[a].destroy();var r=Charts.PIE_CHART_TYPES[a];Charts._pieCharts[a]=Highcharts.chart(r.container,{chart:{style:{fontFamily:"'Gotham Rounded', sans-serif"},plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie"},title:{text:e.title+r.title,align:"left",style:{color:"#717171",textTransform:"uppercase",fontSize:12},margin:40},tooltip:{formatter:function(){var t=this.key,e=Util.percentage(this.percentage),a=Util.currency(this.y);return"<b>"+Lang.get("admin.chart.keys."+t)+"</b><br>Porcentaje: <b>"+e+"</b><br>Venta: <b>"+a+"</b>"},backgroundColor:"#fff",borderRadius:4},plotOptions:{pie:{colors:["#00CC7B","#F4707B","#9F5AB1","#FFA738","#9245A7","#2A99D6","#D95C9B","#8F7260","#D6C29A","#9F5AB1"],cursor:"pointer",dataLabels:{formatter:function(){return Lang.get("admin.chart.keys."+this.point.name)+"<br>("+Util.percentage(this.percentage)+")"}}}},series:[{type:"pie",name:"Porcentaje",allowPointSelect:!0,colorByPoint:!0,data:t}]})},Charts.buildColChart=function(t,e){var a=$("[data-sales-by-users]"),r=_.sumBy(t,"y"),n=["#00CC7B","#F4707B","#9F5AB1","#FFA738","#9245A7","#2A99D6","#D95C9B","#8F7260","#D6C29A","#9F5AB1"];a.find("tbody").html(""),a.find("[data-interval-title]").html(e.title+" <b>Según Usuario</b>"),_.forEach(t,function(t,e){var i=Util.percentageFrom(r,t.y),o="<tr>";o+="<td>"+t.name+'<div class="progress"><div class="progress-bar" role="progressbar" style="background-color:'+n[e%10]+";width: "+i+'%" aria-valuenow="'+i+'" aria-valuemin="0" aria-valuemax="100"></div></div></td>',o+='<td class="text-right">'+Util.currency(t.y)+'<br><small class="text-muted">('+Util.percentage(i)+")</small></td>",o+="</tr>",a.find("tbody").append(o)})},Charts.buildGroup=function(t,e,a,r){var n=$(r+"-content").find(".js-group-by-user"),i=Util.unique(t,"user"),o=Util.options(i);n.html(o),n.unbind("change").on("change",function(){var r,i=n.val().trim();r=i?t.filter(function(t){return t.user==i}):t;var o=Util.groupingBy(r,a);Charts.buildPieChart(o,e,a)});var l=Util.groupingBy(t,a);Charts.buildPieChart(l,e,a)};var Dashboard={};Dashboard.INTERVALS={year:{id:"year",lesser:"month",formatStart:"YYYY-MM-DD 00:00:00",formatEnd:"YYYY-MM-DD 23:59:59",title:"Ventas del Año"},week:{id:"week",lesser:"day",formatStart:"YYYY-MM-DD 00:00:00",formatEnd:"YYYY-MM-DD 23:59:59",title:"Ventas de la Semana"},day:{id:"day",lesser:"hour",formatStart:"YYYY-MM-DD 00:00:00",formatEnd:"YYYY-MM-DD 23:59:59",title:"Ventas del Día"},month:{id:"month",lesser:"day",formatStart:"YYYY-MM-01 00:00:00",formatEnd:"YYYY-MM-DD 23:59:59",title:"Ventas del Mes Actual"},ytd:{id:"ytd",lesser:"month",formatStart:"YYYY-01-01 00:00:00",formatEnd:"YYYY-MM-DD 23:59:59",title:"Ventas del Año Actual"},range:{id:"range",lesser:"days",formatStart:"YYYY-MM-DD 00:00:00",formatEnd:"YYYY-MM-DD 23:59:59",title:"Ventas por Rango de Fecha"}},Dashboard.APIURL=function(t){return"/admin/dashboard/sales/"+[t.start,t.finish,t.groupby].join("/")+(Dashboard.COMPANY?"?company="+Dashboard.COMPANY:"")},Dashboard.init=function(t){Dashboard.COMPANY=t,moment.updateLocale($("html").attr("lang"),{week:{dow:0}}),Dashboard.bindings(),Dashboard.prepare($("#line-chart").data("default"))},Dashboard.bindings=function(){var t=moment().startOf("month"),e=moment().endOf("month");$(".js-group").click(function(){var a=$(this),r=a.data("interval");Dashboard.prepare(r),"range"==r&&Dashboard.prepareRange(t,e)}),new Calendar({element:$(".daterange--double"),earliest_date:moment($(".daterange--double").data("earliest-date")),latest_date:moment(),start_date:t,end_date:e,presets:!1,callbackAlways:!0,callback:function(){t=moment(this.start_date),e=moment(this.end_date),Dashboard.prepareRange(moment(this.start_date),moment(this.end_date))}})},Dashboard.hilightActive=function(t){$(".js-group").removeClass("active"),$(".js-group[data-interval="+t+"]").addClass("active")},Dashboard.prepare=function(t){Dashboard.hilightActive(t);var e=Dashboard.INTERVALS[t];if("range"==t)return Dashboard.nodata(),void Dashboard.showRange();Dashboard.loading(),Dashboard.hideRange(),Dashboard.buildData(e)},Dashboard.prepareRange=function(t,e){if(t&&e){var a=Dashboard.INTERVALS.range;Dashboard.loading(),Dashboard.buildData(a,t,e,!0)}},Dashboard.buildData=function(t,e,a,r){var n,i,o=t.id,l=new Date;return"range"!=o?(n=moment(l),"ytd"!=o&&"month"!=o&&n.subtract(1,o),n=n.format(t.formatStart),i=moment(l).format(t.formatEnd)):(n=e.format(t.formatStart),i=a.format(t.formatEnd)),Dashboard.getData(t,n,i).then(function(e){var a=Util.groupingByDate(e,o,t),l=Util.groupingBy(e,"user");l=_.orderBy(l,"y","desc"),a=Util.addMissingIntervals(a,{interval:t,start:n,end:i}),Charts.buildLineChart(a,t,r),Charts.buildColChart(l,t),Charts.buildGroup(e,t,"creditcard",".js-credit-card-chart"),Charts.buildGroup(e,t,"category",".js-category-chart"),Charts.buildGroup(e,t,"device",".js-device-chart")})},Dashboard.getData=function(t,e,a){var r=(t.id,t.lesser),n=Dashboard.APIURL({start:e,finish:a,groupby:r});return $.getJSON(n)},Dashboard.loading=function(){$(".main-chart").hide(),$(".aditional-charts").hide(),$(".loader").show()},Dashboard.chartReady=function(){$(".is-empty").hide(),$(".main-chart").show(),$(".aditional-charts").show(),$(".line-chart-container").show(),$(".loader").hide()},Dashboard.nodata=function(){$(".is-empty").show(),$(".main-chart").show(),$(".aditional-charts").hide(),$(".line-chart-container").hide(),$(".loader").hide(),Charts._lineChart=0},Dashboard.showRange=function(){Dashboard.prepareRange(),$(".date-range").show(),$(".is-empty").hide()},Dashboard.hideRange=function(){$(".date-range").hide()};